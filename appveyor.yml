version: '{build}'
branches:
  only:
  - master
# clone_folder: C:/projects/bfa
image:
  - Visual Studio 2015
  - Visual Studio 2017
#  - Ubuntu
configuration: Release
platform: x64
environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true
  DOCKER_IMAGE: ubuntu:16.04
  matrix:
  - TARGET_PLATFORM: x64
  - TARGET_PLATFORM: x86
  
matrix:
  fast_finish: true
  exclude:
    - image: Ubuntu
      TARGET_PLATFORM: x86

# skip unsupported combinations
init:
  - ps: |
      If ($isLinux) {
        $env:APPVEYOR_CACHE_SKIP_RESTORE = "true"
        $env:APPVEYOR_CACHE_SKIP_SAVE = "true"
      }
  - cmd: |
      set arch=
      if "%TARGET_PLATFORM%"=="x64" ( set arch= Win64)
      If "%APPVEYOR_BUILD_WORKER_IMAGE%"=="Visual Studio 2017" ( set generator="Visual Studio 15 2017%arch%" )
      If "%APPVEYOR_BUILD_WORKER_IMAGE%"=="Visual Studio 2015" ( set generator="Visual Studio 14 2015%arch%" )
      If "%APPVEYOR_BUILD_WORKER_IMAGE%"=="Ubuntu" ( set generator="Unix Makefiles" )
      echo %generator%
  - sh: |
      docker pull $DOCKER_IMAGE
#- set arch=
#- if "%arch%"=="Win64" ( set arch= Win64)
#- echo %arch%
#- echo %APPVEYOR_BUILD_WORKER_IMAGE%
#- if "%APPVEYOR_BUILD_WORKER_IMAGE%"=="Visual Studio 2017" ( set generator="Visual Studio 15 2017%arch%" )
#- if "%APPVEYOR_BUILD_WORKER_IMAGE%"=="Visual Studio 2015" ( set generator="Visual Studio 14 2015%arch%" )
#- if "%APPVEYOR_BUILD_WORKER_IMAGE%"=="Ubuntu" ( set generator="Unix Makefiles" )
#- echo %generator%
#- sh: sh build_files/build_environment/install_deps.sh --with-all --no-confirm

install:
- sh: cmake

build_script:
  if "%TARGET_PLATFORM%"=="x86" (svn checkout https://svn.blender.org/svnroot/bf-blender/trunk/lib/windows_vc14 ../lib/windows_vc14)
  if "%TARGET_PLATFORM%"=="x64" (svn checkout https://svn.blender.org/svnroot/bf-blender/trunk/lib/win64_vc14 ../lib/win64_vc14)
  ./make.bat release

#    call build_files/build_environment/windows/install_cuda.cmd
    
#build:
#  project: C:/projects/bfa/build/bforartists.sln
#  verbosity: minimal
#  parallel: true
deploy:
  release: Bforartists
  description: 'Bforartists AppVeyor Release Test'
  provider: GitHub
  auth_token:
    secure: "ERlWoOkrphep39WP0GCsrJuIT2PxoQq4bxUrHZMLXq7Swlf7paDlXPW8C2yS2S1DOpRmZrD3jwIp8lu1OhVYoke8rGURXdRvKyNKpHUfYYDZZmY81sAhYQPCXW3AblurbgqpzJkwJADDA108KYJ6RQ/iOYVdmxaJ1hz/LYGBVbl5Us2i7iGY1JlC3SMNXDt2AH3aLHlOltywNaOcus9aSATGyQVcbzToBh7AhrzvlDNVV1huMwOFEVu9PFnxS8J7KtBVK/tQ3vJEvNkcusCMN5p5Ut8C423MQj/26GBkKN0FJ8wOAuXvi32F1/6F2vFx7Vguzqs/+YQMRdeP5ReLgdBNDJNFuoR0M5hlcXNGNJKY+O5rPJJMaT0S78t5vYD5Bt+9cyNIPnbai6dOlqahAvMEzrdoTJrhK+E0aAgKqybOLObJeqmPCDXsgBo+su3ZHk5nBRH1RQtg6ToYVl2wmZJd/BkwLnLYzzT5sHD4gddHxOFa5uSqUqR9RQeL2olL21lCj8wJ4k43jb9zAqZ7qtgSDCFVpIgnvOO2fVIhfKb6OteaEkD8B4D3mLdlq9N73v9nFASviqM7ry5GOaLHPqSPya9Lv3rArHUzHso2sf2KtJB7Z/uYYiCxgFU5/YN+ajngrovzqvU43HsF9ShjcMmwrxadHqR45/6U+qq82HQ="
  artifact: C:/projects/bfa/build/*.exe
  draft: false
  prerelease: false
  on:
    branch: master
    appveyor_repo_tag: true
